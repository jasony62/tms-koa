# 存储结构

上传文件的存储位置：`/rootDir/domain/bucket/YYYYMM/DDHH`。

上传文件的命名：`mmss+4位随机数`。

配置文件`fs.js`中指定的`rootDir`。

请求中指定的`domain`，通过`domain`对文件进行业务级的分类，默认值`upload`。

根据当前用户获得的`bucket`，实现按用户的访问控制，默认值为空。

# 配置文件（/config/fs.js）

文件管理，例如：保存上传文件

```javascript
module.exports = {
  local: {
    rootDir: 'files' // 指定保存文件的根目录
    outDir: 'files' // 指定系统生成文件的根目录
    domain: {
      default: 'upload',
      valid: []
    },
    bucket: {
      module: ''
    },
    accessControl: {
      module: '' // 返回检查函数的模块地址
    }
    database: {
      dialect: 'mongodb',
      database:'upload',
      file_table: 'files'
    },
    schemas: {
      $schema: 'http://json-schema.org/draft-07/schema#',
      type: 'object',
      title: 'Json-Doc-File',
      description: 'tms-vue-finder file',
      properties: {
        comment: {
          type: 'string',
          minLength: 0,
          maxLength: 80,
          title: '说明1',
          attrs: {
            placeholder: '请输入说明',
            title: '说明1'
          }
        }
      }
    }
  }
}
```

tms-koa 支持保存上传文件的扩展信息。可以指定将信息保存在数据库中，例如：mongodb。指定的数据库需要在/config/mongodb.js 中存在。

## domain

如果需要将不同的业务文件存储在不同目录中，例如：用户上传文件和系统公共文件，可以通过设置多个`domain`实现。

`domain`不是必须指定的，如果不指定，默认值为`upload`。

`valid`为允许访问的`domain`数组，可以不将默认 domain 放到列表中。

系统运行时会自动在`rootDir`目录下创建指定的`domain`。

应用发起请求时，可以通过查询参数指定`domain`。

## bucket

如果需要将不同用户的数据存储在不同的目录中，可以通过设置`bucket`实现。

通过`module`参数指定实现获得`bucket`方法的模块。

模块需要参照模板直接导出一个函数，供`tms-koa`调用

```
module.exports = function(client, domain, request) {
  // 业务逻辑
  return bucket
}
```

## 用户指定上传文件命名（customName）

默认情况下，系统自动生成上传文件的目录存放目录及命名。如果需要由用户指定存放目录，并保留上传文件的名字，将此参数设置为`true`。如果此参数设置为`true`，但是没有指定存放目录，那么系统自动生成存放目录，保留文件名。

## 访问控制（accessControl）

如果需要控制用户对存储文件的访问，可以通过设置`accessControl`实现。

通过`module`参数指定进行访问控制的模块。

模块需要参照模板直接导出一个函数，供`tms-koa`调用

```
module.exports = function(client,
      domain,
      bucket,
      path,
      request) {
  // 业务逻辑
  return true // 或者false
}
```

## 数据库（database）

指定用于保存上传文件信息的数据库。

# 文件上传和下载

需要在部署阶段创建程序运行后用到的`domain`，例如在`files`目录下创建`tests`目录，用于保存单元测试产生的文件。

在 controllers 目录创建文件 upload.js（可根据需要命名），用于上传文件。

```javascript
const { UploadCtrl } = require('tms-koa/lib/controller/fs')

class Upload extends UploadCtrl {
  constructor(...args) {
    super(...args)
  }
  async tmsBeforeEach() {
    // 文件服务的基类在tmsBeforeEach方法中执行了异步初始化操作，子类中如果覆盖必须调用基类方法
    await super.tmsBeforeEach()
  }
}

module.exports = Upload
```

上传文件 api：http://localhost:3000/api/fs/upload/plain

在 controllers 目录创建文件 download.js（可根据需要命名），用于下载文件。

```javascript
const { DownloadCtrl } = require('tms-koa/lib/controller/fs')

class Download extends DownloadCtrl {
  constructor(...args) {
    super(...args)
  }
}

module.exports = Download
```

下载 api：http://localhost:3000/api/fs/download/down?file=

在 controllers 目录创建文件 browse.js（可根据需要命名），用于浏览文件。

```javascript
const { BrowseCtrl } = require('tms-koa/lib/controller/fs')

class Browse extends BrowseCtrl {
  constructor(...args) {
    super(...args)
  }
}

module.exports = Browse
```

# 文件信息（schemas）

# API

## browse

| API        | Method |                        |
| ---------- | ------ | ---------------------- |
| list       | GET    | 访问指定文件存储目录   |
| getBizInfo | GET    | 获得单个文件的业务信息 |

## upload

| API   | Method |                                          |
| ----- | ------ | ---------------------------------------- |
| plain | POST   | 通过表单上传文件，`file`字段为上传的文件 |

### 查询参数

| 参数         | 说明                                            |
| ------------ | ----------------------------------------------- |
| dir          | 指定文件存放的位置                              |
| forceReplace | 如果上传文件已经存在是否替换，如果替换设置为`Y` |

## download

| API  | Method |     |
| ---- | ------ | --- |
| down | GET    |     |

## image

| API          | Method | 说明                                                                                                                                                                                                                |
| ------------ | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| uploadBase64 | POST   | 如果`Content-Type`为`text/plain`，post 的内容作为 base64 格式图片数据；如果`Content-type`为`application/json`，post 的对象中，由查询参数`base64Field`指定的字段作为 base64 格式图片数据，其他字段作为文件信息保存。 |

### 查询参数

| 参数         | 说明                                            |
| ------------ | ----------------------------------------------- |
| dir          | 指定文件存放的位置                              |
| forceReplace | 如果上传文件已经存在是否替换，如果替换设置为`Y` |
| base64Field  | post 对象中作为 base64 图片内容的字段           |

## excel

| API    | Method |     |
| ------ | ------ | --- |
| export | POST   |     |

## manage

| API  | Method |                            |
| ---- | ------ | -------------------------- |
| list | GET    | 访问数据库中存储的文件信息 |
